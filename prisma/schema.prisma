generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ AUTH ============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  avatar        String?
  role          UserRole  @default(USER)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  bots             Bot[]
  creditBalance    CreditBalance?
  creditTxns       CreditTransaction[]
  stripeCustomerId String?  @unique
  sessions         Session[]

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

enum UserRole {
  USER
  ADMIN
}

// ============ BOTS ============

model Bot {
  id          String    @id @default(cuid())
  userId      String
  name        String
  description String?
  status      BotStatus @default(PAUSED)

  instructions   String      @db.Text
  brandName      String
  brandKnowledge String?     @db.Text
  safetyLevel    SafetyLevel @default(MODERATE)

  postingSchedule String?
  timezone        String  @default("UTC")

  rssFeeds     Json?
  reactorState Json?
  dedupHistory Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  platformConns PlatformConnection[]
  activities    BotActivity[]
  dailyStats    BotDailyStat[]

  @@index([userId])
  @@index([status])
}

enum BotStatus {
  ACTIVE
  PAUSED
  STOPPED
  ERROR
  NO_CREDITS
}

enum SafetyLevel {
  CONSERVATIVE
  MODERATE
  AGGRESSIVE
}

// ============ PLATFORM CONNECTIONS ============

model PlatformConnection {
  id       String     @id @default(cuid())
  botId    String
  platform PlatformType
  status   ConnStatus @default(DISCONNECTED)

  encryptedCredentials Json
  config               Json?

  postsToday   Int       @default(0)
  repliesToday Int       @default(0)
  lastPostAt   DateTime?
  lastError    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, platform])
  @@index([botId])
}

enum PlatformType {
  MASTODON
  FACEBOOK
  TELEGRAM
  MOLTBOOK
  DISCORD
  TWITTER
  BLUESKY
  REDDIT
  DEVTO
}

enum ConnStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  SUSPENDED
}

// ============ BOT ACTIVITY ============

model BotActivity {
  id       String       @id @default(cuid())
  botId    String
  platform PlatformType
  action   ActionType

  content     String? @db.Text
  postId      String?
  contentType String?

  success Boolean
  error   String?

  likes    Int?
  comments Int?
  shares   Int?

  creditsUsed Int @default(0)

  createdAt DateTime @default(now())

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, createdAt])
  @@index([platform])
}

enum ActionType {
  POST
  REPLY
  FAVOURITE
  BOOST
  SCAN_FEEDS
  COLLECT_METRICS
  GENERATE_CONTENT
  SAFETY_BLOCK
  BAN_DETECTED
}

// ============ DAILY STATS ============

model BotDailyStat {
  id    String   @id @default(cuid())
  botId String
  date  DateTime @db.Date

  postsCount      Int @default(0)
  repliesCount    Int @default(0)
  favouritesCount Int @default(0)
  boostsCount     Int @default(0)
  safetyBlocks    Int @default(0)
  errorsCount     Int @default(0)
  creditsUsed     Int @default(0)

  totalLikes    Int @default(0)
  totalComments Int @default(0)
  totalShares   Int @default(0)

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, date])
  @@index([botId, date])
}

// ============ CREDITS & BILLING ============

model CreditBalance {
  id      String @id @default(cuid())
  userId  String @unique
  balance Int    @default(0)

  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CreditTransaction {
  id     String  @id @default(cuid())
  userId String
  type   TxnType
  amount Int
  balance Int

  description     String?
  botId           String?
  stripePaymentId String?

  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

enum TxnType {
  PURCHASE
  USAGE
  BONUS
  REFUND
  SUBSCRIPTION
}

// ============ ADMIN: PRICING ============

model PricingPlan {
  id       String  @id @default(cuid())
  name     String
  credits  Int
  priceUsd Int
  isActive  Boolean @default(true)
  isPopular Boolean @default(false)
  features  Json?
  sortOrder Int     @default(0)

  stripePriceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ActionCost {
  id          String     @id @default(cuid())
  actionType  ActionType
  credits     Int
  description String?

  @@unique([actionType])
}

model PromoCode {
  id           String    @id @default(cuid())
  code         String    @unique
  discountPct  Int
  bonusCredits Int       @default(0)
  maxUses      Int?
  usedCount    Int       @default(0)
  expiresAt    DateTime?
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
}

// ============ CONTACT ============

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([read])
}
