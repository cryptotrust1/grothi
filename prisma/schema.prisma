generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ AUTH ============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  avatar        String?
  role          UserRole  @default(USER)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  bots             Bot[]
  creditBalance    CreditBalance?
  creditTxns       CreditTransaction[]
  stripeCustomerId String?  @unique
  sessions         Session[]

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

enum UserRole {
  USER
  ADMIN
}

// ============ BOTS ============

model Bot {
  id          String    @id @default(cuid())
  userId      String
  name        String
  description String?
  status      BotStatus @default(PAUSED)

  instructions   String      @db.Text
  brandName      String
  brandKnowledge String?     @db.Text
  safetyLevel    SafetyLevel @default(MODERATE)

  // Goal & Strategy
  goal        BotGoal  @default(ENGAGEMENT)
  targetUrl   String?
  keywords    Json?
  utmSource   String?  @default("grothi")
  utmMedium   String?  @default("social")

  // Google Analytics Integration
  gaPropertyId   String?
  gaCredentials  Json?

  // Scheduling
  postingSchedule String?
  timezone        String  @default("UTC")

  // AI Engine State
  rssFeeds         Json?
  reactorState     Json?
  dedupHistory     Json?
  algorithmConfig  Json?
  imagePreferences Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  platformConns   PlatformConnection[]
  activities      BotActivity[]
  dailyStats      BotDailyStat[]
  media           Media[]
  scheduledPosts  ScheduledPost[]
  postEngagements PostEngagement[]
  rlArmStates     RLArmState[]
  rlConfigs       RLConfig[]

  @@index([userId])
  @@index([status])
}

enum BotStatus {
  ACTIVE
  PAUSED
  STOPPED
  ERROR
  NO_CREDITS
}

enum SafetyLevel {
  CONSERVATIVE
  MODERATE
  AGGRESSIVE
}

enum BotGoal {
  TRAFFIC
  SALES
  ENGAGEMENT
  BRAND_AWARENESS
  LEADS
  COMMUNITY
}

// ============ PLATFORM CONNECTIONS ============

model PlatformConnection {
  id       String     @id @default(cuid())
  botId    String
  platform PlatformType
  status   ConnStatus @default(DISCONNECTED)

  encryptedCredentials Json
  config               Json?

  postsToday   Int       @default(0)
  repliesToday Int       @default(0)
  lastPostAt   DateTime?
  lastError    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, platform])
  @@index([botId])
}

enum PlatformType {
  MASTODON
  FACEBOOK
  TELEGRAM
  MOLTBOOK
  DISCORD
  TWITTER
  BLUESKY
  REDDIT
  DEVTO
  LINKEDIN
  INSTAGRAM
  TIKTOK
  PINTEREST
  THREADS
  MEDIUM
  YOUTUBE
  NOSTR
}

enum ConnStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  SUSPENDED
}

// ============ BOT ACTIVITY ============

model BotActivity {
  id       String       @id @default(cuid())
  botId    String
  platform PlatformType
  action   ActionType

  content     String? @db.Text
  postId      String?
  contentType String?

  success Boolean
  error   String?

  likes    Int?
  comments Int?
  shares   Int?
  saves    Int?

  creditsUsed Int @default(0)

  createdAt DateTime @default(now())

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, createdAt])
  @@index([platform])
}

enum ActionType {
  POST
  REPLY
  FAVOURITE
  BOOST
  SCAN_FEEDS
  COLLECT_METRICS
  GENERATE_CONTENT
  SAFETY_BLOCK
  BAN_DETECTED
}

// ============ DAILY STATS ============

model BotDailyStat {
  id    String   @id @default(cuid())
  botId String
  date  DateTime @db.Date

  postsCount      Int @default(0)
  repliesCount    Int @default(0)
  favouritesCount Int @default(0)
  boostsCount     Int @default(0)
  safetyBlocks    Int @default(0)
  errorsCount     Int @default(0)
  creditsUsed     Int @default(0)

  totalLikes    Int @default(0)
  totalComments Int @default(0)
  totalShares   Int @default(0)

  // GA metrics (fetched from user's Google Analytics)
  gaPageviews   Int?
  gaSessions    Int?
  gaConversions Int?
  gaBounceRate  Float?

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, date])
  @@index([botId, date])
}

// ============ CREDITS & BILLING ============

model CreditBalance {
  id      String @id @default(cuid())
  userId  String @unique
  balance Int    @default(0)

  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CreditTransaction {
  id     String  @id @default(cuid())
  userId String
  type   TxnType
  amount Int
  balance Int

  description     String?
  botId           String?
  stripePaymentId String?

  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

enum TxnType {
  PURCHASE
  USAGE
  BONUS
  REFUND
  SUBSCRIPTION
}

// ============ ADMIN: PRICING ============

model PricingPlan {
  id       String  @id @default(cuid())
  name     String
  credits  Int
  priceUsd Int
  isActive  Boolean @default(true)
  isPopular Boolean @default(false)
  features  Json?
  sortOrder Int     @default(0)

  stripePriceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ActionCost {
  id          String     @id @default(cuid())
  actionType  ActionType
  credits     Int
  description String?

  @@unique([actionType])
}

model PromoCode {
  id           String    @id @default(cuid())
  code         String    @unique
  discountPct  Int
  bonusCredits Int       @default(0)
  maxUses      Int?
  usedCount    Int       @default(0)
  expiresAt    DateTime?
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
}

// ============ MEDIA LIBRARY ============

model Media {
  id       String    @id @default(cuid())
  botId    String
  type     MediaType
  filename String
  mimeType String
  fileSize Int
  filePath String
  width    Int?
  height   Int?
  duration Float?

  // AI-generated descriptions per platform
  altText         String?  @db.Text
  aiDescription   String?  @db.Text
  platformCaptions Json?

  // Variants for different platforms (auto-generated)
  variants Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot            Bot             @relation(fields: [botId], references: [id], onDelete: Cascade)
  scheduledPosts ScheduledPost[]

  @@index([botId, createdAt])
  @@index([type])
}

enum MediaType {
  IMAGE
  VIDEO
  GIF
}

// ============ SCHEDULED POSTS ============

model ScheduledPost {
  id       String       @id @default(cuid())
  botId    String
  status   PostStatus   @default(DRAFT)

  // Content
  content     String   @db.Text
  contentType String?
  mediaId     String?

  // Platform targeting
  platforms   Json
  platformContent Json?

  // Scheduling
  scheduledAt DateTime?
  publishedAt DateTime?
  autoSchedule Boolean @default(false)

  // RL Content Strategy
  toneStyle      String?
  hashtagPattern String?

  // Results
  publishResults Json?
  error          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot   Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)
  media Media? @relation(fields: [mediaId], references: [id], onDelete: SetNull)

  @@index([botId, status])
  @@index([scheduledAt])
  @@index([status, scheduledAt])
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
  CANCELLED
}

// ============ REINFORCEMENT LEARNING ============

model PostEngagement {
  id              String       @id @default(cuid())
  botId           String
  platform        PlatformType
  scheduledPostId String?
  activityId      String?
  externalPostId  String?

  // Raw engagement metrics
  likes           Int          @default(0)
  comments        Int          @default(0)
  shares          Int          @default(0)
  saves           Int          @default(0)

  // Platform-specific metrics
  dwellTimeMs     Int?
  watchTimeSec    Float?
  impressions     Int?
  reach           Int?
  clickthroughs   Int?

  // Computed weighted score
  engagementScore Float        @default(0)

  // Content dimensions at time of posting (denormalized for fast queries)
  contentType     String?
  timeSlot        Int?
  dayOfWeek       Int?
  hashtagPattern  String?
  toneStyle       String?

  collectedAt     DateTime?
  postedAt        DateTime     @default(now())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, platform])
  @@index([botId, contentType])
  @@index([botId, platform, timeSlot])
  @@index([postedAt])
}

model RLArmState {
  id          String       @id @default(cuid())
  botId       String
  platform    PlatformType
  dimension   RLDimension
  armKey      String

  // Bandit statistics
  pulls       Int          @default(0)
  totalReward Float        @default(0)
  avgReward   Float        @default(0)
  lastReward  Float        @default(0)
  maxReward   Float        @default(0)

  // Exponentially weighted moving average
  ewmaReward  Float        @default(0)
  variance    Float        @default(0)

  updatedAt   DateTime     @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, platform, dimension, armKey])
  @@index([botId, platform, dimension])
}

model RLConfig {
  id            String       @id @default(cuid())
  botId         String
  platform      PlatformType

  epsilon       Float        @default(0.2)
  epsilonMin    Float        @default(0.05)
  epsilonDecay  Float        @default(0.995)
  totalEpisodes Int          @default(0)
  ewmaAlpha     Float        @default(0.3)

  // Spam prevention state
  lastPostAt          DateTime?
  postsInLastHour     Int      @default(0)
  postsInLast24Hours  Int      @default(0)
  consecutiveSameType Int      @default(0)
  lastContentType     String?

  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, platform])
  @@index([botId])
}

enum RLDimension {
  TIME_SLOT
  CONTENT_TYPE
  HASHTAG_PATTERN
  TONE_STYLE
}

// ============ CONTACT ============

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([read])
}
