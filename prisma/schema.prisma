generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ AUTH ============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  avatar        String?
  role          UserRole  @default(USER)
  emailVerified Boolean   @default(false)
  isBlocked     Boolean   @default(false)
  blockedAt     DateTime?
  blockedReason String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 2FA fields
  twoFactorEnabled       Boolean  @default(false)
  twoFactorSecret        String?
  twoFactorRecoveryCodes Json?

  bots             Bot[]
  creditBalance    CreditBalance?
  creditTxns       CreditTransaction[]
  stripeCustomerId String?  @unique
  sessions         Session[]
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens     PasswordResetToken[]

  @@index([email])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

enum UserRole {
  USER
  ADMIN
}

// ============ BOTS ============

model Bot {
  id          String    @id @default(cuid())
  userId      String
  name        String
  description String?
  status      BotStatus @default(PAUSED)

  instructions   String      @db.Text
  brandName      String
  brandKnowledge String?     @db.Text
  safetyLevel    SafetyLevel @default(MODERATE)

  // Goal & Strategy
  goal        BotGoal  @default(ENGAGEMENT)
  targetUrl   String?
  keywords    Json?
  utmSource   String?  @default("grothi")
  utmMedium   String?  @default("social")

  // Google Analytics Integration
  gaPropertyId   String?
  gaCredentials  Json?

  // Scheduling
  postingSchedule String?
  timezone        String  @default("UTC")

  // AI Engine State
  rssFeeds            Json?
  reactorState        Json?
  dedupHistory        Json?
  algorithmConfig     Json?
  imagePreferences    Json?
  creativePreferences Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  platformConns   PlatformConnection[]
  activities      BotActivity[]
  dailyStats      BotDailyStat[]
  media           Media[]
  scheduledPosts  ScheduledPost[]
  postEngagements PostEngagement[]
  rlArmStates     RLArmState[]
  rlConfigs       RLConfig[]
  contentPlans    PlatformContentPlan[]
  emailAccount       EmailAccount?
  emailLists         EmailList[]
  emailCampaigns     EmailCampaign[]
  emailAutomations   EmailAutomation[]
  signupForms        SignupForm[]
  ecommerceConns     EcommerceConnection[]

  @@index([userId])
  @@index([status])
}

enum BotStatus {
  ACTIVE
  PAUSED
  STOPPED
  ERROR
  NO_CREDITS
}

enum SafetyLevel {
  CONSERVATIVE
  MODERATE
  AGGRESSIVE
}

enum BotGoal {
  TRAFFIC
  SALES
  ENGAGEMENT
  BRAND_AWARENESS
  LEADS
  COMMUNITY
}

// ============ PLATFORM CONNECTIONS ============

model PlatformConnection {
  id       String     @id @default(cuid())
  botId    String
  platform PlatformType
  status   ConnStatus @default(DISCONNECTED)

  encryptedCredentials Json
  config               Json?

  postsToday   Int       @default(0)
  repliesToday Int       @default(0)
  lastPostAt   DateTime?
  lastError    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, platform])
  @@index([botId])
}

enum PlatformType {
  MASTODON
  FACEBOOK
  TELEGRAM
  MOLTBOOK
  DISCORD
  TWITTER
  BLUESKY
  REDDIT
  DEVTO
  LINKEDIN
  INSTAGRAM
  TIKTOK
  PINTEREST
  THREADS
  MEDIUM
  YOUTUBE
  NOSTR
}

enum ConnStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  SUSPENDED
}

// ============ BOT ACTIVITY ============

model BotActivity {
  id       String       @id @default(cuid())
  botId    String
  platform PlatformType
  action   ActionType

  content     String? @db.Text
  postId      String?
  contentType String?

  success Boolean
  error   String?

  likes    Int?
  comments Int?
  shares   Int?
  saves    Int?

  creditsUsed Int @default(0)

  createdAt DateTime @default(now())

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, createdAt])
  @@index([platform])
}

enum ActionType {
  POST
  REPLY
  FAVOURITE
  BOOST
  SCAN_FEEDS
  COLLECT_METRICS
  GENERATE_CONTENT
  GENERATE_IMAGE
  GENERATE_VIDEO
  SAFETY_BLOCK
  BAN_DETECTED
  SEND_EMAIL
  GENERATE_EMAIL
}

// ============ DAILY STATS ============

model BotDailyStat {
  id    String   @id @default(cuid())
  botId String
  date  DateTime @db.Date

  postsCount      Int @default(0)
  repliesCount    Int @default(0)
  favouritesCount Int @default(0)
  boostsCount     Int @default(0)
  safetyBlocks    Int @default(0)
  errorsCount     Int @default(0)
  creditsUsed     Int @default(0)

  totalLikes    Int @default(0)
  totalComments Int @default(0)
  totalShares   Int @default(0)

  // GA metrics (fetched from user's Google Analytics)
  gaPageviews   Int?
  gaSessions    Int?
  gaConversions Int?
  gaBounceRate  Float?

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, date])
  @@index([botId, date])
}

// ============ CREDITS & BILLING ============

model CreditBalance {
  id      String @id @default(cuid())
  userId  String @unique
  balance Int    @default(0)

  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CreditTransaction {
  id     String  @id @default(cuid())
  userId String
  type   TxnType
  amount Int
  balance Int

  description     String?
  botId           String?
  stripePaymentId String?

  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

enum TxnType {
  PURCHASE
  USAGE
  BONUS
  REFUND
  SUBSCRIPTION
}

// ============ ADMIN: PRICING ============

model PricingPlan {
  id       String  @id @default(cuid())
  name     String
  credits  Int
  priceUsd Int
  isActive  Boolean @default(true)
  isPopular Boolean @default(false)
  features  Json?
  sortOrder Int     @default(0)

  stripePriceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ActionCost {
  id          String     @id @default(cuid())
  actionType  ActionType
  credits     Int
  description String?

  @@unique([actionType])
}

model PromoCode {
  id           String    @id @default(cuid())
  code         String    @unique
  discountPct  Int
  bonusCredits Int       @default(0)
  maxUses      Int?
  usedCount    Int       @default(0)
  expiresAt    DateTime?
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
}

// ============ MEDIA LIBRARY ============

model Media {
  id       String    @id @default(cuid())
  botId    String
  type     MediaType
  filename String
  mimeType String
  fileSize Int
  filePath String
  width    Int?
  height   Int?
  duration Float?

  // AI-generated descriptions per platform
  altText         String?  @db.Text
  aiDescription   String?  @db.Text
  platformCaptions Json?

  // Variants for different platforms (auto-generated)
  variants Json?

  // AI generation tracking (for async predictions like video)
  replicatePredictionId String?   @unique
  generationStatus      String?   // PENDING, PROCESSING, SUCCEEDED, FAILED, CANCELLED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot            Bot             @relation(fields: [botId], references: [id], onDelete: Cascade)
  scheduledPosts ScheduledPost[]

  @@index([botId, createdAt])
  @@index([botId, generationStatus])
  @@index([type])
}

enum MediaType {
  IMAGE
  VIDEO
  GIF
}

// ============ SCHEDULED POSTS ============

model ScheduledPost {
  id       String       @id @default(cuid())
  botId    String
  status   PostStatus   @default(DRAFT)

  // Content
  content     String   @db.Text
  contentType String?
  mediaId     String?

  // Platform targeting
  platforms   Json
  platformContent Json?

  // Scheduling
  scheduledAt DateTime?
  publishedAt DateTime?
  autoSchedule Boolean @default(false)

  // RL Content Strategy
  toneStyle      String?
  hashtagPattern String?

  // Results
  publishResults Json?
  error          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot   Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)
  media Media? @relation(fields: [mediaId], references: [id], onDelete: SetNull)

  @@index([botId, status])
  @@index([botId, scheduledAt])
  @@index([scheduledAt])
  @@index([status, scheduledAt])
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
  CANCELLED
}

// ============ REINFORCEMENT LEARNING ============

model PostEngagement {
  id              String       @id @default(cuid())
  botId           String
  platform        PlatformType
  scheduledPostId String?
  activityId      String?
  externalPostId  String?

  // Raw engagement metrics
  likes           Int          @default(0)
  comments        Int          @default(0)
  shares          Int          @default(0)
  saves           Int          @default(0)

  // Platform-specific metrics
  dwellTimeMs     Int?
  watchTimeSec    Float?
  impressions     Int?
  reach           Int?
  clickthroughs   Int?

  // Computed weighted score
  engagementScore Float        @default(0)

  // Content dimensions at time of posting (denormalized for fast queries)
  contentType     String?
  timeSlot        Int?
  dayOfWeek       Int?
  hashtagPattern  String?
  toneStyle       String?

  collectedAt     DateTime?
  postedAt        DateTime     @default(now())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId, platform])
  @@index([botId, contentType])
  @@index([botId, platform, timeSlot])
  @@index([postedAt])
}

model RLArmState {
  id          String       @id @default(cuid())
  botId       String
  platform    PlatformType
  dimension   RLDimension
  armKey      String

  // Bandit statistics
  pulls       Int          @default(0)
  totalReward Float        @default(0)
  avgReward   Float        @default(0)
  lastReward  Float        @default(0)
  maxReward   Float        @default(0)

  // Exponentially weighted moving average
  ewmaReward  Float        @default(0)
  variance    Float        @default(0)

  updatedAt   DateTime     @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, platform, dimension, armKey])
  @@index([botId, platform, dimension])
}

model RLConfig {
  id            String       @id @default(cuid())
  botId         String
  platform      PlatformType

  epsilon       Float        @default(0.2)
  epsilonMin    Float        @default(0.05)
  epsilonDecay  Float        @default(0.995)
  totalEpisodes Int          @default(0)
  ewmaAlpha     Float        @default(0.3)

  // Spam prevention state
  lastPostAt          DateTime?
  postsInLastHour     Int      @default(0)
  postsInLast24Hours  Int      @default(0)
  consecutiveSameType Int      @default(0)
  lastContentType     String?

  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, platform])
  @@index([botId])
}

enum RLDimension {
  TIME_SLOT
  CONTENT_TYPE
  HASHTAG_PATTERN
  TONE_STYLE
}

// ============ PLATFORM CONTENT PLANS ============

model PlatformContentPlan {
  id        String       @id @default(cuid())
  botId     String
  platform  PlatformType
  enabled   Boolean      @default(true)

  // Daily content quotas
  dailyTexts    Int @default(1)
  dailyImages   Int @default(1)
  dailyVideos   Int @default(0)
  dailyStories  Int @default(0)

  // Platform-specific style overrides (null = use bot defaults)
  toneOverride       String?
  imageStyleOverride String?
  videoStyleOverride String?
  hashtagOverride    String?

  // Video preferences for this platform
  videoLength   String?
  videoFormat   String?

  // Posting windows (JSON array of hour ints, e.g. [9,13,17])
  postingHours  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, platform])
  @@index([botId])
}

// ============ SYSTEM SETTINGS ============

model SystemSetting {
  id    String @id @default(cuid())
  key   String @unique
  value String @db.Text

  updatedAt DateTime @updatedAt
}

// ============ EMAIL TOKENS ============

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// ============ CONTACT ============

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([read])
}

// ============ EMAIL MARKETING ============

model EmailAccount {
  id         String        @id @default(cuid())
  botId      String        @unique
  provider   EmailProvider @default(CUSTOM)
  email      String
  fromName   String?

  // Auth method: SMTP (password) or OAuth2
  authMethod EmailAuthMethod @default(SMTP)

  // SMTP credentials (password encrypted with AES-256-GCM)
  smtpHost   String
  smtpPort   Int           @default(587)
  smtpUser   String
  smtpPass   String        // encrypted
  smtpSecure Boolean       @default(false)

  // OAuth2 tokens (encrypted)
  oauthAccessToken  String?
  oauthRefreshToken String?
  oauthTokenExpiry  DateTime?
  oauthClientId     String?

  // CAN-SPAM: physical mailing address (required in every commercial email)
  physicalAddress String?

  // Sending limits
  dailyLimit  Int      @default(2000)
  sentToday   Int      @default(0)
  lastResetAt DateTime @default(now())

  // Status
  isVerified Boolean @default(false)
  lastError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot       Bot             @relation(fields: [botId], references: [id], onDelete: Cascade)
  campaigns EmailCampaign[]

  @@index([botId])
}

enum EmailAuthMethod {
  SMTP
  OAUTH2
}

enum EmailProvider {
  GOOGLE
  MICROSOFT
  SENDGRID
  MAILGUN
  AMAZON_SES
  POSTMARK
  CUSTOM
}

model EmailList {
  id           String  @id @default(cuid())
  botId        String
  name         String
  description  String?
  contactCount Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot         Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  contacts    EmailContact[]
  campaigns   EmailCampaign[]
  signupForms SignupForm[]

  @@index([botId])
}

model SignupForm {
  id     String @id @default(cuid())
  botId  String
  listId String
  name   String

  // Form configuration
  fields      Json    @default("[\"email\",\"firstName\"]") // array of field names
  buttonText  String  @default("Subscribe")
  successMsg  String  @default("Thanks for subscribing!")
  description String?

  // Styling
  brandColor String @default("#6366f1")
  style      String @default("inline") // inline, popup, embedded

  // Double opt-in
  doubleOptIn Boolean @default(false)

  // Stats
  submissions Int @default(0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot  Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)
  list EmailList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([listId])
}

model EmailContact {
  id           String        @id @default(cuid())
  listId       String
  email        String
  firstName    String?
  lastName     String?
  tags         Json?
  customFields Json?

  // GDPR consent tracking
  consentedAt   DateTime?
  consentSource String?

  // Status
  status ContactStatus @default(ACTIVE)

  // Engagement metrics
  lastOpenAt  DateTime?
  lastClickAt DateTime?
  openCount   Int @default(0)
  clickCount  Int @default(0)

  // Bounce tracking (soft bounces auto-suppress after threshold)
  softBounceCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  list        EmailList              @relation(fields: [listId], references: [id], onDelete: Cascade)
  sends       EmailSend[]
  events      EmailEvent[]
  enrollments AutomationEnrollment[]

  @@unique([listId, email])
  @@index([listId])
  @@index([email])
  @@index([status])
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  COMPLAINED
}

model EmailCampaign {
  id        String @id @default(cuid())
  botId     String
  accountId String
  listId    String

  name      String
  subject   String
  preheader String?
  fromName  String?

  // Content
  htmlContent String  @db.Text
  textContent String? @db.Text

  // A/B Testing
  subjectB      String?
  abTestPercent Int?      @default(20)
  abWinner      String?

  // Status
  status CampaignStatus @default(DRAFT)

  // Scheduling
  scheduledAt DateTime?
  sentAt      DateTime?
  completedAt DateTime?

  // Aggregated stats
  totalSent         Int @default(0)
  totalOpened       Int @default(0)
  totalClicked      Int @default(0)
  totalBounced      Int @default(0)
  totalComplaints   Int @default(0)
  totalUnsubscribed Int @default(0)

  creditsUsed Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot     Bot          @relation(fields: [botId], references: [id], onDelete: Cascade)
  account EmailAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  list    EmailList    @relation(fields: [listId], references: [id], onDelete: Cascade)
  sends   EmailSend[]

  @@index([botId])
  @@index([status])
  @@index([scheduledAt])
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
  FAILED
}

model EmailSend {
  id         String     @id @default(cuid())
  campaignId String
  contactId  String

  status    SendStatus @default(QUEUED)
  messageId String?
  variant   String?    // A/B test variant: "A" or "B"
  retries   Int        @default(0)

  openedAt  DateTime?
  clickedAt DateTime?
  bouncedAt DateTime?
  error     String?

  sentAt    DateTime?
  createdAt DateTime @default(now())

  campaign EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  EmailContact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  events   EmailEvent[]

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@index([status])
}

enum SendStatus {
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  FAILED
}

model EmailEvent {
  id        String         @id @default(cuid())
  sendId    String
  contactId String
  type      EmailEventType
  data      Json?

  ip        String?
  userAgent String?

  createdAt DateTime @default(now())

  send    EmailSend    @relation(fields: [sendId], references: [id], onDelete: Cascade)
  contact EmailContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([sendId])
  @@index([contactId])
  @@index([type])
  @@index([createdAt])
}

enum EmailEventType {
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  UNSUBSCRIBED
}

// ============ EMAIL AUTOMATIONS ============

model EmailAutomation {
  id             String         @id @default(cuid())
  botId          String
  name           String
  type           AutomationType
  isActive       Boolean        @default(false)

  // Trigger config
  triggerListId  String?
  triggerConfig  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot         Bot                     @relation(fields: [botId], references: [id], onDelete: Cascade)
  steps       EmailAutomationStep[]
  enrollments AutomationEnrollment[]

  @@index([botId])
  @@index([type])
}

model EmailAutomationStep {
  id           String @id @default(cuid())
  automationId String
  stepOrder    Int

  subject     String
  htmlContent String  @db.Text
  textContent String? @db.Text

  // Delay before sending
  delayDays  Int @default(0)
  delayHours Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  automation EmailAutomation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
}

model AutomationEnrollment {
  id           String  @id @default(cuid())
  automationId String
  contactId    String
  currentStep  Int     @default(0) // 0 = not yet sent step 1
  completed    Boolean @default(false)
  cancelled    Boolean @default(false)

  // When the next step should fire
  nextStepAt   DateTime?
  lastStepAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  automation EmailAutomation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  contact    EmailContact    @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([automationId, contactId])
  @@index([automationId])
  @@index([nextStepAt])
}

enum AutomationType {
  WELCOME
  RE_ENGAGEMENT
  DRIP
  ABANDONED_CART
}

// ============ E-COMMERCE INTEGRATIONS ============

model EcommerceConnection {
  id       String         @id @default(cuid())
  botId    String
  platform EcommercePlatform
  name     String

  // Connection credentials (encrypted)
  shopDomain String        // e.g. mystore.myshopify.com
  apiKey     String        // encrypted
  apiSecret  String?       // encrypted (for Shopify)
  webhookSecret String?    // for verifying incoming webhooks

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot   Bot             @relation(fields: [botId], references: [id], onDelete: Cascade)
  carts AbandonedCart[]

  @@unique([botId, platform])
  @@index([botId])
}

model AbandonedCart {
  id           String @id @default(cuid())
  connectionId String
  externalId   String // cart/checkout ID from the store

  customerEmail String
  customerName  String?
  cartTotal     Float
  currency      String  @default("USD")
  cartItems     Json    // array of { name, price, quantity, imageUrl, productUrl }

  // Recovery tracking
  recoveryEmailSent Boolean  @default(false)
  recoveredAt       DateTime?
  recoveryValue     Float?

  abandonedAt DateTime
  createdAt   DateTime @default(now())

  connection EcommerceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([connectionId, externalId])
  @@index([connectionId])
  @@index([customerEmail])
  @@index([recoveryEmailSent])
  @@index([abandonedAt])
}

enum EcommercePlatform {
  SHOPIFY
  WOOCOMMERCE
}
