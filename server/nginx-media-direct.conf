# Direct media file serving for Meta platforms (Instagram, Threads, Facebook)
#
# Meta's crawlers cannot download media through Cloudflare due to bot protection.
# This server block serves media files directly via the server IP on port 8787,
# bypassing Cloudflare entirely.
#
# Place at: /etc/nginx/sites-available/grothi-media-direct
# Enable: ln -s /etc/nginx/sites-available/grothi-media-direct /etc/nginx/sites-enabled/
# Reload: sudo nginx -t && sudo systemctl reload nginx
#
# IMPORTANT: Ensure port 8787 is open in the firewall for external access:
#   sudo ufw allow 8787/tcp    (if using ufw)
#   OR: sudo iptables -A INPUT -p tcp --dport 8787 -j ACCEPT
#
# Access pattern: http://89.167.18.92:8787/media/{botId}/{filename}
# Example: http://89.167.18.92:8787/media/cmlqaun8d00061ggn8houb7n4/2b0bad15-0967-4595-980c-3e39f00c4737.png

server {
    listen 8787;
    server_name _;

    # CRITICAL: Disable gzip for this entire server block.
    # When gzip is enabled (often globally in nginx.conf), Nginx strips the
    # Content-Length header and uses chunked Transfer-Encoding instead.
    # Instagram's media downloader requires Content-Length to validate the
    # response as a real image/video file. Without it, Instagram returns
    # error 9004 "Only photo or video can be accepted as media type".
    gzip off;

    # Use sendfile for efficient static file serving (zero-copy from disk)
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # Restrict to media files only — no other paths exposed
    location /media/ {
        alias /home/acechange-bot/grothi/data/uploads/;

        # Only serve known image/video MIME types
        types {
            image/jpeg  jpg jpeg;
            image/png   png;
            image/gif   gif;
            image/webp  webp;
            video/mp4   mp4;
            video/webm  webm;
        }
        default_type application/octet-stream;

        # Allow Meta crawlers (and anyone with the unguessable URL)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Cache-Control "public, max-age=86400" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Ensure Accept-Ranges is sent (needed for video streaming and
        # helps Meta crawlers validate file size before full download)
        add_header Accept-Ranges "bytes" always;

        # Disable directory listing
        autoindex off;

        # Disable SSI and sub_filter which can strip Content-Length
        ssi off;

        # Limit file size for served files (50MB — matches our upload limit)
        # This prevents abuse of the open port
        limit_rate_after 10m;
        limit_rate 5m;
    }

    # Block everything else
    location / {
        return 444;
    }
}
