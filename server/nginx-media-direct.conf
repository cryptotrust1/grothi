# Direct media file serving for Meta platforms (Instagram, Threads, Facebook)
#
# Meta's crawlers cannot download media through Cloudflare due to bot protection.
# This server block serves media files directly via the server IP on port 8787,
# bypassing Cloudflare entirely.
#
# Place at: /etc/nginx/sites-available/grothi-media-direct
# Enable: ln -s /etc/nginx/sites-available/grothi-media-direct /etc/nginx/sites-enabled/
#
# Access pattern: http://89.167.18.92:8787/media/{botId}/{filename}
# Example: http://89.167.18.92:8787/media/cmlqaun8d00061ggn8houb7n4/2b0bad15-0967-4595-980c-3e39f00c4737.png

server {
    listen 8787;
    server_name _;

    # Restrict to media files only â€” no other paths exposed
    location /media/ {
        alias /home/acechange-bot/grothi/data/uploads/;

        # Only serve known image/video MIME types
        types {
            image/jpeg  jpg jpeg;
            image/png   png;
            image/gif   gif;
            image/webp  webp;
            video/mp4   mp4;
            video/webm  webm;
        }
        default_type application/octet-stream;

        # Allow Meta crawlers (and anyone with the unguessable URL)
        add_header Access-Control-Allow-Origin "*" always;
        add_header Cache-Control "public, max-age=86400" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Disable directory listing
        autoindex off;
    }

    # Block everything else
    location / {
        return 444;
    }
}
